{% extends 'core/base.html' %} {# Corrigido: Extende o base.html #}
{% load static %}

{% block title %}Minha Equipe - Temeisheng{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm" style="background-color: #34495e; border-radius: 10px; border: 2px solid #2c3e50;">
                <div class="card-header text-white text-center" style="background-color: #2c3e50; border-bottom: 2px solid #2c3e50;">
                    <h3 class="mb-0" style="color: #ecf0f1;">Minha Equipe</h3>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <p class="text-center mb-4" style="color: #bdc3c7;">Aqui você encontra as informações sobre os membros da sua equipe e os subsídios de convite.</p>

                    <div class="mb-4">
                        <h3 style="color: #3498db;">Seu Link de Convite:</h3>
                        <div class="input-group">
                            {# CORREÇÃO AQUI: Acessando referral_code diretamente de request.user #}
                            <input type="text" id="referralLink" class="form-control" value="{{ request.scheme }}://{{ request.get_host }}{% url 'cadastro' %}?ref={{ request.user.referral_code }}" readonly style="background-color: #2c3e50; border-color: #3498db; color: #ecf0f1;">
                            <button type="button" class="btn btn-primary" style="background-color: #3498db; border-color: #3498db;" onclick="copyToClipboard('referralLink')">
                                <i class="fas fa-copy"></i> Copiar
                            </button>
                        </div>
                        <small class="form-text" style="color: #bdc3c7;">Compartilhe este link para convidar novos membros.</small>
                    </div>

                    <div class="mb-4">
                        <h3 style="color: #3498db;">Subsídios de Convites:</h3>
                        <p style="color: #ecf0f1;">
                            Sempre que convidar alguém para se inscrever com o seu link, se a pessoa que convidares tiver um nível ativo, você receberá um subsídio de <strong style="color: #1abc9c;">500 KZ</strong>. Este valor é gerado automaticamente na sua conta no indicador "Subsídio".
                        </p>
                        <div class="alert alert-info" role="alert" style="background-color: #2c3e50; border-color: #3498db; color: #ecf0f1;">
                            {# CORREÇÃO AQUI: Acessando saldo_subsidy via request.user.saldo #}
                            Seu Subsídio Atual: <strong style="color: #1abc9c;">{{ request.user.saldo.saldo_subsidy|floatformat:2|default:"0.00" }} Kz</strong>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3 style="color: #3498db;">Membros da Sua Equipe:</h3>
                        {% if equipe %}
                            <ul class="list-group">
                                {# Itere sobre os membros da equipe (passados do seu views.py) #}
                                {% for membro in equipe %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center" style="background-color: #2c3e50; border-color: #3498db; color: #ecf0f1;">
                                        {# CORREÇÃO AQUI: Usando phone_number ou first_name em vez de username #}
                                        {{ membro.first_name|default:membro.phone_number }} (Telefone: {{ membro.phone_number }})
                                        {# CORREÇÃO AQUI: Verificando se o saldo do membro existe e se o nível não expirou #}
                                        {% if membro.saldo and not membro.saldo.nivel_expirado %}
                                            <span class="badge bg-success rounded-pill">Nível Ativo</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark rounded-pill">Nível Inativo</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="color: #bdc3c7;">Você ainda não tem membros na sua equipe. Compartilhe seu link de convite!</p>
                        {% endif %}
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <a href="{% url 'menu' %}" class="btn btn-secondary btn-lg" style="background-color: #7f8c8d; border-color: #7f8c8d;">Voltar ao Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# O JavaScript para copiar o link pode ficar aqui ou em um arquivo .js separado, carregado no base.html #}
<script>
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const textToCopy = element.value; // Para input, use .value
        navigator.clipboard.writeText(textToCopy).then(() => {
            alert('Link de convite copiado para a área de transferência!');
        }).catch(err => {
            console.error('Falha ao copiar: ', err);
            // Fallback para navegadores mais antigos ou se a permissão não for concedida
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Link de convite copiado para a área de transferência! (Fallback)');
            } catch (err) {
                console.error('Fallback: Falha ao copiar: ', err);
            }
            document.body.removeChild(textArea);
        });
    }
</script>

{% endblock content %} {# Fechar o bloco content #}

{# Removido o <header>, <footer> e scripts globais que devem vir do base.html #}
{# Não precisa de <body>, <html> tags aqui, pois o base.html já as fornece. #}
    